#!/bin/bash

vdirsyncer sync

export RESTIC_REPOSITORY="$(security find-generic-password -s "com.landmaj.restic" -a "restic-repository" -w)"
export RESTIC_PASSWORD="$(security find-generic-password -s "com.landmaj.restic" -a "restic-password" -w)"
export AWS_ACCESS_KEY_ID="$(security find-generic-password -s "com.landmaj.restic" -a "aws-key-id" -w)"
export AWS_SECRET_ACCESS_KEY="$(security find-generic-password -s "com.landmaj.restic" -a "aws-access-key" -w)"

restic backup --host Shandris --exclude='.DS_Store' \
    "${HOME}/Documents" \
    "${HOME}/Library/Mobile Documents/com~apple~CloudDocs" \
    "${HOME}/Library/Mobile Documents/com~apple~Keynote/Documents" \
    "${HOME}/Library/Mobile Documents/com~apple~Numbers/Documents" \
    "${HOME}/Library/Mobile Documents/com~apple~Pages/Documents" \
    "${HOME}/Library/Mobile Documents/iCloud~md~obsidian"

restic forget --group-by '' --keep-last 1 --keep-daily 7 --keep-weekly 52 --keep-yearly 100 --prune
